'use strict';

var DockerRunner = require('../lib/docker-exec'),
    helper = require('./_helper/config');

describe('docker-exec', function () {

    var ds = null;

    before(function(done){
        ds = new DockerRunner(helper.getExecConfig());
        done();
    });

    it('run', function (done) {
        this.timeout(1000000);
        console.log('start new container');

        ds.start({
            Image: 'chrisrock/spaceportci-ruby'
        }).then(function (stream) {
            stream.pipe(process.stdout);
        }).then(function () {
            return ds.run('git clone git://github.com/TelekomLabs/puppet-os-hardening.git TelekomLabs/puppet-os-hardening');
        }).then(function () {
            return ds.run('cd TelekomLabs/puppet-os-hardening');
        }).then(function () {
            return ds.run('git checkout -qf 260b0983e6452d2f923dc1b4d97e381f490bf371');
        }).then(function () {
            return ds.run('source /etc/profile.d/rvm.sh');
        }).then(function () {
            return ds.run('rvm use 1.9.3 --install --binary --fuzzy');
        }).then(function () {
            return ds.run('ruby --version');
        }).then(function () {
            return ds.run('rvm --version');
        }).then(function () {
            return ds.run('gem --version');
        }).then(function () {
            return ds.run('gem install bundler');
        }).then(function () {
            return ds.run('bundle --version');
        }).then(function () {
            return ds.run('bundle install --without development integration openstack');
        }).then(function () {
            return ds.run('bundle exec rake');
        }).then(function (code) {
            console.log('Run done with exit code: ' + code);
            // stop container
            return ds.stop();
        }).then(function () {
            
            done();
        }).catch(function (err) {
            console.log('Done with error');
            console.log(err);
        });

    });
});